import{_ as oe}from"./jNmtiVgl.js";import{o as n,c as r,a as e,t as a,F as k,r as C,n as le,g as u,j as ae,k as ne,l,b as E,w as re,m as q,v as ie,p as de,q as H,s as A,x as M,y as U,z as ue,T as ce,A as v,d as me}from"./D8_npMnH.js";const pe={class:"text-xs mb-3"},fe={class:"border-t border-b border-gray-400 py-2 my-2"},be={class:"text-right font-bold text-base mt-3"},xe={class:"text-xs mt-4 text-center text-gray-600 border-t border-dashed border-gray-400 pt-3"},ve={__name:"ReceiptPrint",props:{sale:{type:Object,default:null},items:{type:Array,default:()=>[]},total:{type:Number,default:0},paymentMethod:{type:String,default:"CASH"},cashierName:{type:String,default:""},show:{type:Boolean,default:!1}},setup(b,{expose:y}){const S=b,h=u(null),f=i=>new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(i||0),c=i=>new Date(i).toLocaleString();return y({print:()=>{if(!S.show)return;const i=h.value;if(!i)return;const d=i.cloneNode(!0);d.classList.remove("sr-only","hidden");const p=d.outerHTML,m=window.open("","_blank");if(!m){alert("Please allow popups to print the receipt.");return}m.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Receipt</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: monospace; padding: 16px; font-size: 12px; max-width: 80mm; margin: 0 auto; background: #fff; color: #000; }
            .receipt-print { background: #fff; color: #000; padding: 24px; font-size: 12px; max-width: 80mm; margin: 0 auto; }
          </style>
        </head>
        <body>${p}</body>
      </html>
    `),m.document.close(),m.focus(),m.print(),m.close()}}),(i,d)=>(n(),r("div",{ref_key:"receiptRef",ref:h,class:le(["receipt-print bg-white text-black p-6 font-mono text-sm max-w-[80mm] mx-auto",{hidden:!b.show}])},[d[1]||(d[1]=e("div",{class:"text-center mb-4 border-b border-dashed border-gray-400 pb-3"},[e("h2",{class:"text-lg font-bold"},"DIASO"),e("p",{class:"text-xs text-gray-600"},"Point of Sale Receipt")],-1)),e("div",pe,[e("p",null,"Receipt #: "+a(b.sale?.orderNumber||"-"),1),e("p",null,"Date: "+a(c(new Date)),1),e("p",null,"Cashier: "+a(b.cashierName),1)]),e("div",fe,[(n(!0),r(k,null,C(b.items,(p,m)=>(n(),r("div",{key:m,class:"flex justify-between py-1"},[e("span",null,a(p.product?.itemName)+" x"+a(p.quantity),1),e("span",null,a(f(p.quantity*p.unitPrice)),1)]))),128))]),e("div",be," TOTAL: "+a(f(b.total)),1),e("div",xe,[e("p",null,"Payment: "+a(b.paymentMethod),1),d[0]||(d[0]=e("p",{class:"mt-2"},"Thank you for your purchase!",-1))])],2))}},he={class:"pos-container max-w-6xl mx-auto"},ye={key:0,class:"flex flex-col items-center justify-center min-h-[60vh] text-slate-400"},ge={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},we={class:"lg:col-span-2 h-[calc(100vh-11rem)] min-h-0 flex flex-col"},_e={class:"bg-slate-800 rounded-xl border border-slate-700 p-4 h-full overflow-y-auto flex flex-col"},ke={class:"relative mb-4 flex-shrink-0"},Ce=["onKeydown"],Se={key:0,class:"absolute z-10 w-full mt-1 bg-slate-700 border border-slate-600 rounded-lg shadow-xl max-h-64 overflow-y-auto"},Ne=["onClick"],Pe={class:"text-emerald-400 text-sm"},De={class:"grid grid-cols-2 sm:grid-cols-3 gap-2 flex-1 min-h-0 overflow-y-auto"},Ie=["onClick"],qe={class:"font-medium text-white truncate"},Ae={class:"text-emerald-400 text-sm mt-1"},Me={class:"text-slate-500 text-xs mt-0.5"},Le={class:"h-[calc(100vh-11rem)] min-h-0 flex flex-col"},Te={class:"bg-slate-800 rounded-xl border border-slate-700 p-4 h-full overflow-y-auto flex flex-col"},$e={key:0,class:"text-slate-500 py-8 text-center text-sm"},Fe={key:1,class:"space-y-2 flex-1 min-h-0 overflow-y-auto mb-4"},Re={class:"min-w-0 flex-1"},Ue={class:"text-white truncate text-sm"},Oe={class:"text-slate-400 text-xs"},je={class:"flex items-center gap-2"},Ve=["onClick"],ze={class:"text-white w-6 text-center text-sm"},Be=["disabled","onClick"],Ee=["onClick"],He={class:"border-t border-slate-600 pt-4 flex-shrink-0"},We={class:"flex justify-between text-slate-400 text-sm mb-2"},Ke={class:"text-xl font-bold text-emerald-400"},Ye={class:"mb-4"},Qe=["value"],Ge={class:"mb-4"},Je={key:0,class:"text-amber-400 text-xs mt-1"},Xe={class:"mb-4"},Ze={key:0,class:"mb-4 text-amber-400 text-sm"},et=["disabled"],tt={class:"bg-slate-800 rounded-xl border border-slate-600 p-6 max-w-sm w-full shadow-xl"},st={class:"text-center mb-6"},ot={class:"text-slate-400 text-sm mt-1"},nt={__name:"pos",setup(b){const{$api:y}=ae(),S=u([]),h=u([]),f=u(""),c=u([]),i=u(""),d=u("PAID"),p=u("CASH"),m=u(!1),g=u(""),O=u(!1),L=u(!1),N=u(null),T=u([]),$=u(0),j=u(null),W=v(()=>{try{const s=JSON.parse(localStorage.getItem("user")||"{}");return s.firstName&&s.lastName?`${s.firstName} ${s.lastName}`:s.username||"Cashier"}catch{return"Cashier"}}),V=v(()=>S.value.filter(s=>s.currentStock>0)),P=v(()=>{const s=f.value.toLowerCase().trim();return s?V.value.filter(t=>t.itemName.toLowerCase().includes(s)||t.barcodeNumber&&t.barcodeNumber.toLowerCase().includes(s)):[]}),w=v(()=>c.value.reduce((s,t)=>s+t.quantity*Number(t.unitPrice),0)),K=v(()=>i.value?h.value.find(t=>t.id===i.value)?.name||"Customer":"Walk-in Customer"),Y=v(()=>d.value==="PAID"?w.value:0),z=v(()=>!(c.value.length===0||d.value==="UNPAID"&&!i.value)),D=s=>new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(s)||0),F=s=>{const t=c.value.find(_=>_.productId===s.id);t?t.quantity<s.currentStock&&t.quantity++:c.value.push({productId:s.id,product:s,quantity:1,unitPrice:s.sellingPrice}),f.value=""},Q=()=>{P.value.length>0&&F(P.value[0])},G=s=>{const t=c.value[s];t.quantity<t.product.currentStock&&t.quantity++},J=s=>{const t=c.value[s];t.quantity>1?t.quantity--:c.value.splice(s,1)},X=s=>{c.value.splice(s,1)},Z=async()=>{if(!z.value){g.value=d.value==="UNPAID"&&!i.value?"Select a lender for unpaid sales":"Add items to cart";return}g.value="",m.value=!0;try{const s=w.value,t=Y.value,_=c.value.map(o=>{const x=o.quantity*Number(o.unitPrice),I=s>0?x/s*t:0;return{productId:o.productId,quantity:o.quantity,unitPrice:o.unitPrice,customerId:i.value||null,customerName:K.value,paymentMethod:p.value,paymentStatus:d.value,amountPaid:Math.round(I*100)/100,notes:"POS Sale"}}),R=await y.post("/sales/bulk",{sales:_,totalAmount:w.value});N.value={orderNumber:R.orderNumber},T.value=[...c.value],$.value=w.value,c.value=[],L.value=!0}catch(s){alert(s.message||"Failed to complete sale")}finally{m.value=!1}},ee=()=>{j.value?.print()},B=()=>{L.value=!1,N.value=null,T.value=[],$.value=0,g.value=""},te=async()=>{try{const s=await y.get("/products",{limit:500});S.value=s.products||[]}catch(s){console.error("Failed to load products:",s)}},se=async()=>{try{const s=await y.get("/lenders",{limit:200});h.value=s.lenders||[]}catch(s){console.error("Failed to load lenders:",s)}};return ne(()=>{const s=localStorage.getItem("token");O.value=!!s,s&&(te(),se())}),(s,t)=>{const _=oe,R=ve;return n(),r("div",he,[l(O)?(n(),r("div",ge,[e("div",we,[e("div",_e,[e("div",ke,[q(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>A(f)?f.value=o:null),type:"text",placeholder:"Search by product name or barcode...",class:"w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent",onKeydown:de(H(Q,["prevent"]),["enter"])},null,40,Ce),[[ie,l(f)]]),l(f)&&l(P).length>0?(n(),r("div",Se,[(n(!0),r(k,null,C(l(P).slice(0,8),o=>(n(),r("button",{key:o.id,type:"button",class:"w-full text-left px-4 py-3 hover:bg-slate-600 flex justify-between items-center",onClick:x=>F(o)},[e("span",null,a(o.itemName),1),e("span",Pe,a(D(o.sellingPrice))+" · Stock: "+a(o.currentStock),1)],8,Ne))),128))])):M("",!0)]),e("div",De,[(n(!0),r(k,null,C(l(V),o=>(n(),r("button",{key:o.id,type:"button",class:"bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded-lg p-3 text-left transition-colors",onClick:x=>F(o)},[e("p",qe,a(o.itemName),1),e("p",Ae,a(D(o.sellingPrice)),1),e("p",Me,"Stock: "+a(o.currentStock),1)],8,Ie))),128))])])]),e("div",Le,[e("div",Te,[t[13]||(t[13]=e("h2",{class:"text-lg font-semibold text-white mb-4"},"Cart",-1)),l(c).length===0?(n(),r("div",$e," No items. Search or tap a product to add. ")):(n(),r("div",Fe,[(n(!0),r(k,null,C(l(c),(o,x)=>(n(),r("div",{key:x,class:"flex items-center justify-between bg-slate-700 rounded-lg px-3 py-2"},[e("div",Re,[e("p",Ue,a(o.product.itemName),1),e("p",Oe,a(D(o.unitPrice))+" × "+a(o.quantity),1)]),e("div",je,[e("button",{type:"button",class:"w-7 h-7 rounded bg-slate-600 hover:bg-slate-500 text-white text-sm font-bold",onClick:I=>J(x)}," − ",8,Ve),e("span",ze,a(o.quantity),1),e("button",{type:"button",class:"w-7 h-7 rounded bg-slate-600 hover:bg-slate-500 text-white text-sm font-bold disabled:opacity-50",disabled:o.quantity>=o.product.currentStock,onClick:I=>G(x)}," + ",8,Be),e("button",{type:"button",class:"text-red-400 hover:text-red-300 text-sm ml-1",onClick:I=>X(x)}," ✕ ",8,Ee)])]))),128))])),e("div",He,[e("div",We,[t[6]||(t[6]=e("span",null,"Total",-1)),e("span",Ke,a(D(l(w))),1)]),e("div",Ye,[t[8]||(t[8]=e("label",{class:"block text-slate-400 text-xs mb-1"},"Customer / Lender (optional)",-1)),q(e("select",{"onUpdate:modelValue":t[1]||(t[1]=o=>A(i)?i.value=o:null),class:"w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"},[t[7]||(t[7]=e("option",{value:""},"Walk-in customer",-1)),(n(!0),r(k,null,C(l(h),o=>(n(),r("option",{key:o.id,value:o.id},a(o.name),9,Qe))),128))],512),[[U,l(i)]])]),e("div",Ge,[t[10]||(t[10]=e("label",{class:"block text-slate-400 text-xs mb-1"},"Payment Status",-1)),q(e("select",{"onUpdate:modelValue":t[2]||(t[2]=o=>A(d)?d.value=o:null),class:"w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"},[...t[9]||(t[9]=[e("option",{value:"PAID"},"Paid",-1),e("option",{value:"UNPAID"},"Unpaid",-1)])],512),[[U,l(d)]]),l(d)==="UNPAID"?(n(),r("p",Je," Unpaid sales require a lender. Select a customer above. ")):M("",!0)]),e("div",Xe,[t[12]||(t[12]=e("label",{class:"block text-slate-400 text-xs mb-1"},"Payment Method",-1)),q(e("select",{"onUpdate:modelValue":t[3]||(t[3]=o=>A(p)?p.value=o:null),class:"w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"},[...t[11]||(t[11]=[e("option",{value:"CASH"},"Cash",-1),e("option",{value:"MOBILE_MONEY"},"Mobile Money",-1),e("option",{value:"CREDIT"},"Credit",-1)])],512),[[U,l(p)]])]),l(g)?(n(),r("div",Ze,a(l(g)),1)):M("",!0),e("button",{disabled:!l(z)||l(m),class:"w-full py-3 bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition-colors",onClick:Z},a(l(m)?"Processing...":"Complete Sale"),9,et)])])])])):(n(),r("div",ye,[t[5]||(t[5]=e("p",{class:"mb-4"},"You need to sign in to use the POS.",-1)),E(_,{to:"/login",class:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-500"},{default:re(()=>[...t[4]||(t[4]=[me(" Go to Login ",-1)])]),_:1})])),(n(),ue(ce,{to:"body"},[l(L)?(n(),r("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4",onClick:H(B,["self"])},[e("div",tt,[e("div",st,[t[14]||(t[14]=e("div",{class:"w-14 h-14 rounded-full bg-emerald-500/20 flex items-center justify-center mx-auto mb-3"},[e("span",{class:"text-2xl text-emerald-400"},"✓")],-1)),t[15]||(t[15]=e("h3",{class:"text-lg font-semibold text-white"},"Sale Completed",-1)),e("p",ot,"Order "+a(l(N)?.orderNumber),1)]),E(R,{ref_key:"receiptRef",ref:j,sale:l(N),items:l(T),total:l($),"payment-method":l(p),"cashier-name":l(W),show:!0,class:"sr-only"},null,8,["sale","items","total","payment-method","cashier-name"]),e("div",{class:"flex gap-3 mt-4"},[e("button",{class:"flex-1 py-3 bg-slate-600 hover:bg-slate-500 text-white font-medium rounded-lg",onClick:ee}," Print Receipt "),e("button",{class:"flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-medium rounded-lg",onClick:B}," New Sale ")])])])):M("",!0)]))])}}};export{nt as default};

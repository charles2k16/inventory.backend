// Prisma Schema for Inventory & Accounting App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Products/Items in inventory
model Product {
  id              String   @id @default(uuid())
  itemNumber      Int      @unique @default(autoincrement())
  barcodeNumber   String?
  itemName        String
  itemDescription String?
  type            String   @default("Product")
  currentStock    Int      @default(0)
  sellingPrice    Decimal  @db.Decimal(10, 2)
  costPrice       Decimal  @default(0) @db.Decimal(10, 2)
  units           String   @default("Product")
  category        String   @default("Equipment")
  locationName    String   @default("Diaso")
  reorderLevel    Int      @default(10) // Low stock alert threshold
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  stockMovements  StockMovement[]
  sales           Sale[]
  returns         Return[]
  additionalStock AdditionalStock[]

  @@index([itemName])
  @@index([category])
}

// Track all stock movements (in/out)
model StockMovement {
  id             String   @id @default(uuid())
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  type           String // "IN", "OUT", "ADJUSTMENT", "RETURN"
  quantity       Int
  quantityBefore Int      @default(0)
  quantityAfter  Int      @default(0)
  reason         String? // "SALE", "PURCHASE", "RETURN", "DAMAGE", "ADJUSTMENT"
  reference      String? // Reference to sale/return ID
  notes          String?
  createdBy      String?
  createdByUser  User?    @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now())

  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

// Weekly stock reports (opening & closing)
model WeeklyStockReport {
  id           String   @id @default(uuid())
  weekNumber   Int
  year         Int
  startDate    DateTime
  endDate      DateTime
  openingStock Json // {productId: quantity, ...}
  closingStock Json // {productId: quantity, ...}
  totalValue   Decimal  @db.Decimal(12, 2)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([weekNumber, year])
  @@index([year, weekNumber])
}

// Sales transactions
model Sale {
  id              String   @id @default(uuid())
  saleNumber      String   @unique
  bulkOrderNumber String? // Links related sales from bulk operations
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  quantity        Int
  unitPrice       Decimal  @db.Decimal(10, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)
  customerId      String?
  customerName    String?
  paymentMethod   String   @default("CASH") // "CASH", "CREDIT", "MOBILE_MONEY"
  paymentStatus   String   @default("PAID") // "PAID", "PENDING", "PARTIAL"
  amountPaid      Decimal  @db.Decimal(12, 2)
  amountDue       Decimal  @default(0) @db.Decimal(12, 2)
  soldBy          String?
  notes           String?
  saleDate        DateTime @default(now())
  createdAt       DateTime @default(now())

  // Relations
  lender  Lender?  @relation(fields: [customerId], references: [id])
  returns Return[]

  @@index([productId])
  @@index([customerId])
  @@index([saleDate])
  @@index([paymentStatus])
  @@index([bulkOrderNumber])
}

// Returns/Refunds
model Return {
  id           String   @id @default(uuid())
  returnNumber String   @unique
  saleId       String?
  sale         Sale?    @relation(fields: [saleId], references: [id])
  productId    String
  product      Product  @relation(fields: [productId], references: [id])
  quantity     Int
  reason       String // "DEFECTIVE", "WRONG_ITEM", "CUSTOMER_REQUEST", etc.
  refundAmount Decimal  @db.Decimal(10, 2)
  refundMethod String   @default("CASH") // "CASH", "CREDIT_NOTE"
  status       String   @default("PENDING") // "PENDING", "APPROVED", "COMPLETED"
  returnedBy   String?
  notes        String?
  returnDate   DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([productId])
  @@index([saleId])
  @@index([returnDate])
}

// Additional stock purchases (weekly additions)
model AdditionalStock {
  id            String   @id @default(uuid())
  batchNumber   String   @unique
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  quantity      Int
  costPerUnit   Decimal  @db.Decimal(10, 2)
  totalCost     Decimal  @db.Decimal(12, 2)
  supplier      String?
  invoiceNumber String?
  weekNumber    Int
  year          Int
  notes         String?
  purchaseDate  DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([productId])
  @@index([year, weekNumber])
  @@index([purchaseDate])
}

// Lenders/Credit customers
model Lender {
  id             String   @id @default(uuid())
  customerCode   String   @unique
  name           String
  phone          String?
  email          String?
  address        String?
  creditLimit    Decimal  @default(0) @db.Decimal(12, 2)
  currentDebt    Decimal  @default(0) @db.Decimal(12, 2)
  totalPurchased Decimal  @default(0) @db.Decimal(12, 2)
  totalPaid      Decimal  @default(0) @db.Decimal(12, 2)
  status         String   @default("ACTIVE") // "ACTIVE", "SUSPENDED", "BLOCKED"
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  sales    Sale[]
  payments Payment[]

  @@index([name])
  @@index([status])
}

// Payments from lenders
model Payment {
  id            String   @id @default(uuid())
  paymentNumber String   @unique
  lenderId      String
  lender        Lender   @relation(fields: [lenderId], references: [id])
  amount        Decimal  @db.Decimal(12, 2)
  paymentMethod String   @default("CASH") // "CASH", "MOBILE_MONEY", "BANK_TRANSFER"
  reference     String?
  notes         String?
  receivedBy    String?
  paymentDate   DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([lenderId])
  @@index([paymentDate])
}

// Users/Staff
model User {
  id             String          @id @default(uuid())
  username       String          @unique
  email          String          @unique
  password       String
  firstName      String
  lastName       String
  role           String          @default("SALES") // "ADMIN", "MANAGER", "SALES"
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  stockMovements StockMovement[]
  activityLogs   ActivityLog[]

  @@index([username])
  @@index([email])
}

// System settings
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  category  String?
  updatedAt DateTime @updatedAt
}

// Activity Log - Audit trail for all user activities
model ActivityLog {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action       String // "CREATE", "UPDATE", "DELETE", "LOGIN", "BULK_IMPORT", etc.
  resourceType String // "PRODUCT", "SALE", "RETURN", "STOCK_REPORT", "LENDER", "CUSTOMER", etc.
  resourceId   String? // ID of the affected resource
  description  String // Human-readable description of the action
  changes      Json? // Optional: { before: {...}, after: {...} } for edit operations
  ipAddress    String? // Client IP for security tracking
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
}
